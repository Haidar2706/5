<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üìú –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞–≤–æ–∫</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .history-container {
      max-width: 800px;
      margin: 30px auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .history-controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    .history-table {
      width: 100%;
      border-collapse: collapse;
    }
    .history-table th, .history-table td {
      padding: 8px 10px;
      border: 1px solid #ddd;
      text-align: center;
    }
    .status-win { color: green; font-weight: bold; }
    .status-lose { color: red; }
    .status-active { color: #007bff; }
    .btn-download {
      margin-top: 15px;
      padding: 10px 15px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="history-container">
  <h2>üìú –ú–æ—è –∏—Å—Ç–æ—Ä–∏—è —Å—Ç–∞–≤–æ–∫</h2>
  <div class="history-controls">
    <label>
      –ü–æ–∫–∞–∑–∞—Ç—å:
      <select id="filterSelect">
        <option value="all">–í—Å–µ —Å—Ç–∞–≤–∫–∏</option>
        <option value="win">–¢–æ–ª—å–∫–æ –≤—ã–∏–≥—Ä–∞–Ω–Ω—ã–µ</option>
        <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
      </select>
    </label>
    <a href="index.html?from=cabinet" class="btn">‚Üê –ù–∞–∑–∞–¥</a>

  </div>

  <table class="history-table" id="historyTable">
    <thead>
      <tr>
        <th>–õ–æ—Ç</th>
        <th>–ú–æ—è —Å—Ç–∞–≤–∫–∞</th>
        <th>–î–∞—Ç–∞</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
      </tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>
  <button class="btn-download" onclick="downloadHistory()">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é (JSON)</button>
<button class="btn-download" onclick="downloadHistoryExcel()">üìä –°–∫–∞—á–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é (Excel)</button>
</div>

<!-- ‚úÖ –ü–æ–¥–∫–ª—é—á–∞–µ–º XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
   currentUser = JSON.parse(localStorage.getItem('auctionUser') || 'null');
  const lots = JSON.parse(localStorage.getItem('lots') || '[]');
  const winners = JSON.parse(localStorage.getItem('winners') || '[]');
  const historyBody = document.getElementById('historyBody');
  const filterSelect = document.getElementById('filterSelect');

  if (!currentUser) {
    document.body.innerHTML = `<div class='history-container'><p>‚ùå –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ <a href='index.html'>–≥–ª–∞–≤–Ω—É—é</a>.</p></div>`;
  } else {
    renderHistory('all');
  }

  filterSelect?.addEventListener('change', e => {
    renderHistory(e.target.value);
  });

  function renderHistory(filter) {
    historyBody.innerHTML = '';

    const myBids = [];
    lots.forEach(lot => {
      lot.bids?.forEach(bid => {
        if (bid.user === currentUser.username) {
          const isWinner = winners.some(w => w.title === lot.title && w.winner === bid.user);
          const status = lot.status === 'active' ? 'active' : (isWinner ? 'win' : 'lose');
          myBids.push({
            title: lot.title,
            amount: bid.amount,
            date: new Date(bid.time).toLocaleString(),
            status
          });
        }
      });
    });

    const filtered = myBids.filter(b => {
      if (filter === 'win') return b.status === 'win';
      if (filter === 'active') return b.status === 'active';
      return true;
    });

    if (filtered.length === 0) {
      historyBody.innerHTML = `<tr><td colspan='4'>üòî –ù–µ—Ç —Å—Ç–∞–≤–æ–∫ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞</td></tr>`;
      return;
    }

    filtered.forEach(b => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${b.title}</td>
        <td>${b.amount} —Å–æ–º</td>
        <td>${b.date}</td>
        <td class="${b.status === 'win' ? 'status-win' : b.status === 'lose' ? 'status-lose' : 'status-active'}">
          ${b.status === 'win' ? '‚úÖ –í—ã–∏–≥—Ä–∞–Ω' : b.status === 'lose' ? '‚ùå –ü—Ä–æ–∏–≥—Ä–∞–Ω' : '‚è≥ –ê–∫—Ç–∏–≤–µ–Ω'}
        </td>
      `;
      historyBody.appendChild(tr);
    });
  }

  function downloadHistory() {
    const rows = [];
    document.querySelectorAll('#historyBody tr').forEach(tr => {
      const cols = tr.querySelectorAll('td');
      rows.push({
        lot: cols[0].textContent,
        bid: cols[1].textContent,
        date: cols[2].textContent,
        status: cols[3].textContent
      });
    });
    const blob = new Blob([JSON.stringify(rows, null, 2)], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `my-bids-history.json`;
    link.click();
  }

  // ‚úÖ –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è Excel
  function downloadHistoryExcel() {
    const rows = [];
    document.querySelectorAll('#historyBody tr').forEach(tr => {
      const cols = tr.querySelectorAll('td');
      rows.push({
        "–õ–æ—Ç": cols[0].textContent,
        "–°—Ç–∞–≤–∫–∞": cols[1].textContent,
        "–î–∞—Ç–∞": cols[2].textContent,
        "–°—Ç–∞—Ç—É—Å": cols[3].textContent
      });
    });

    if (rows.length === 0) {
      alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞");
      return;
    }

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞–≤–æ–∫");
    XLSX.writeFile(wb, `my-bids-history.xlsx`);
  }
</script>
</body>
</html>
